From 17bef6b908f7de339a56b1628cb3d131f6eb3cb8 Mon Sep 17 00:00:00 2001
From: Jimmy Xiang <jxiang@cloudera.com>
Date: Wed, 21 Mar 2012 13:49:24 -0700
Subject: [PATCH 027/101] HBASE-4291. More descriptive string for region state in AssignmentManager web ui

Reason: Better debuggability of HMaster state
Author: Todd Lipcon
Ref: CDH-3540
---
 .../tmpl/master/AssignmentManagerStatusTmpl.jamon  |    2 +-
 .../hadoop/hbase/master/AssignmentManager.java     |   15 ++++++++++++++-
 2 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/src/main/jamon/org/apache/hbase/tmpl/master/AssignmentManagerStatusTmpl.jamon b/src/main/jamon/org/apache/hbase/tmpl/master/AssignmentManagerStatusTmpl.jamon
index f527904..62a63b1 100644
--- a/src/main/jamon/org/apache/hbase/tmpl/master/AssignmentManagerStatusTmpl.jamon
+++ b/src/main/jamon/org/apache/hbase/tmpl/master/AssignmentManagerStatusTmpl.jamon
@@ -36,7 +36,7 @@ No regions in transition.
 	<table>
 		<tr><th>Region</th><th>State</th></tr>
 		<%for Map.Entry<String, RegionState> entry : rit.entrySet() %>
-		<tr><td><% entry.getKey() %></td><td><% entry.getValue() %></td>
+		<tr><td><% entry.getKey() %></td><td><% entry.getValue().toDescriptiveString() %></td>
 		</%for>
 	</table>
 </%if>
\ No newline at end of file
diff --git a/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java b/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java
index a08065e..089e2b3 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java
@@ -25,6 +25,7 @@ import java.io.IOException;
 import java.lang.Thread.UncaughtExceptionHandler;
 import java.util.ArrayList;
 import java.util.Arrays;
+import java.util.Date;
 import java.util.HashMap;
 import java.util.HashSet;
 import java.util.Iterator;
@@ -564,7 +565,7 @@ public class AssignmentManager extends ZooKeeperListener {
           return;
         }
         // Handle this the same as if it were opened and then closed.
-        regionState.update(RegionState.State.CLOSED, data.getStamp());
+        regionState.update(RegionState.State.CLOSED, data.getStamp(), data.getServerName());
         this.executorService.submit(new ClosedRegionHandler(master, this,
             regionState.getRegion()));
         break;
@@ -2404,6 +2405,18 @@ public class AssignmentManager extends ZooKeeperListener {
         + ", server=" + serverName;
     }
 
+    /**
+     * A slower (but more easy-to-read) stringification 
+     */
+    public String toDescriptiveString() {
+      long relTime = System.currentTimeMillis() - stamp;
+      
+      return region.getRegionNameAsString()
+        + " state=" + state
+        + ", ts=" + new Date(stamp) + " (" + (relTime/1000) + "s ago)"
+        + ", server=" + serverName;
+    }
+
     @Override
     public void readFields(DataInput in) throws IOException {
       region = new HRegionInfo();
-- 
1.7.0.4


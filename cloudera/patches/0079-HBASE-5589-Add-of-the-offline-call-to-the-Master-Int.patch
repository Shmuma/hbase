From feb555a4ed4aa04789e2d22ae548a1dd392c8908 Mon Sep 17 00:00:00 2001
From: Jonathan Hsieh <jmhsieh@apache.org>
Date: Wed, 21 Mar 2012 19:32:04 +0000
Subject: [PATCH 079/101] HBASE-5589 Add of the offline call to the Master Interface
 - Includes Addendum
 git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.90@1303522 13f79535-47bb-0310-9956-ffa450edef68

Reason: hbck prerequisite
Author: Jonathan Hsieh
Ref: CDH-4040
---
 .../hadoop/hbase/ipc/HBaseRPCProtocolVersion.java  |    3 +++
 .../apache/hadoop/hbase/ipc/HMasterInterface.java  |   12 ++++++++++++
 .../org/apache/hadoop/hbase/master/HMaster.java    |   13 +++++++++++++
 3 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/ipc/HBaseRPCProtocolVersion.java b/src/main/java/org/apache/hadoop/hbase/ipc/HBaseRPCProtocolVersion.java
index c97b967..b950be2 100644
--- a/src/main/java/org/apache/hadoop/hbase/ipc/HBaseRPCProtocolVersion.java
+++ b/src/main/java/org/apache/hadoop/hbase/ipc/HBaseRPCProtocolVersion.java
@@ -80,7 +80,10 @@ public interface HBaseRPCProtocolVersion extends VersionedProtocol {
    * <li>Version 26: New master and Increment, 0.90 version bump.</li>
    * <li>Version 27: HBASE-3168, Added serverCurrentTime to regionServerStartup
    * in HMasterRegionInterface.</li>
+   * <li>Version 30: HBASE-5589. Added offline method to HMasterRegionInterface.</li>
    * </ul>
+   * 
+   * <p>Note, keeping version at 27 since offline was added after 0.90.0 release.  
    */
   public static final long versionID = 27L;
 }
diff --git a/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java b/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java
index c56b3a6..de6ebe3 100644
--- a/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java
+++ b/src/main/java/org/apache/hadoop/hbase/ipc/HMasterInterface.java
@@ -184,6 +184,18 @@ public interface HMasterInterface extends HBaseRPCProtocolVersion {
    */
   public boolean balance();
 
+  
+  /**
+   * Offline a region from the assignment manager's in-memory state.  The
+   * region should be in a closed state and there will be no attempt to
+   * automatically reassign the region as in unassign.   This is a special
+   * method, and should only be used by experts or hbck.
+   * @param regionName Region to offline.  Will clear any existing RegionPlan
+   * if one found.
+   * @throws IOException
+   */
+  public void offline(final byte[] regionName) throws IOException;
+
   /**
    * Turn the load balancer on or off.
    * @param b If true, enable balancer. If false, disable balancer.
diff --git a/src/main/java/org/apache/hadoop/hbase/master/HMaster.java b/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
index bdf0baa..87bad81 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
@@ -1182,6 +1182,19 @@ implements HMasterInterface, HMasterRegionInterface, MasterServices, Server {
           e.getCause().getMessage(): ""), e);
     }
   }
+  
+  /**
+   * Special method, only used by hbck.
+   */
+  @Override
+  public void offline(final byte[] regionName) 
+  throws IOException {
+    Pair<HRegionInfo, HServerAddress> pair =
+      MetaReader.getRegion(this.catalogTracker, regionName);
+    if (pair == null) throw new UnknownRegionException(Bytes.toStringBinary(regionName));
+    HRegionInfo hri = pair.getFirst();
+    this.assignmentManager.regionOffline(hri);    
+  }
 
 
   /**
-- 
1.7.0.4


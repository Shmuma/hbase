From f5c68f3c2cdf880b95b1e80ac3b1da68f1f5e321 Mon Sep 17 00:00:00 2001
From: Todd Lipcon <todd@cloudera.com>
Date: Sun, 28 Aug 2011 21:19:02 -0700
Subject: [PATCH 40/50] HBASE-4270. Abort and rethrow errors on close failure

Reason: dataloss bug fix
Author: Todd Lipcon
Ref: CDH-3541
---
 .../regionserver/handler/CloseRegionHandler.java   |   10 +++++++---
 1 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/regionserver/handler/CloseRegionHandler.java b/src/main/java/org/apache/hadoop/hbase/regionserver/handler/CloseRegionHandler.java
index 393f6f4..ff5b884 100644
--- a/src/main/java/org/apache/hadoop/hbase/regionserver/handler/CloseRegionHandler.java
+++ b/src/main/java/org/apache/hadoop/hbase/regionserver/handler/CloseRegionHandler.java
@@ -125,9 +125,13 @@ public class CloseRegionHandler extends EventHandler {
             regionInfo.getRegionNameAsString());
           return;
         }
-      } catch (IOException e) {
-        LOG.error("Unrecoverable exception while closing region " +
-          regionInfo.getRegionNameAsString() + ", still finishing close", e);
+      } catch (Throwable t) {
+        // A throwable here indicates that we couldn't successfully flush the
+        // memstore before closing. So, we need to abort the server and allow
+        // the master to split our logs in order to recover the data.
+        server.abort("Unrecoverable exception while closing region " +
+          regionInfo.getRegionNameAsString() + ", still finishing close", t);
+        throw new RuntimeException(t);
       }
 
       this.rsServices.removeFromOnlineRegions(regionInfo.getEncodedName());
-- 
1.7.0.4


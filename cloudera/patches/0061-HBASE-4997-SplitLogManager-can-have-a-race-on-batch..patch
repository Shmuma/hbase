From b91a8b655cb706ddc98a5d13fa71171d73ef0f97 Mon Sep 17 00:00:00 2001
From: Michael Stack <stack@apache.org>
Date: Mon, 12 Dec 2011 22:46:33 +0000
Subject: [PATCH 061/101] HBASE-4997 SplitLogManager can have a race on batch.installed

Reason: Bug
Author: Prakash Khemani
Ref: CDH-3901
---
 .../hadoop/hbase/master/SplitLogManager.java       |   14 ++++++--------
 1 files changed, 6 insertions(+), 8 deletions(-)

diff --git a/src/main/java/org/apache/hadoop/hbase/master/SplitLogManager.java b/src/main/java/org/apache/hadoop/hbase/master/SplitLogManager.java
index da9ece6..971a4af 100644
--- a/src/main/java/org/apache/hadoop/hbase/master/SplitLogManager.java
+++ b/src/main/java/org/apache/hadoop/hbase/master/SplitLogManager.java
@@ -345,9 +345,7 @@ public class SplitLogManager extends ZooKeeperListener {
             } else {
               task.batch.error++;
             }
-            if ((task.batch.done + task.batch.error) == task.batch.installed) {
-              task.batch.notify();
-            }
+            task.batch.notify();
           }
         }
       }
@@ -597,9 +595,9 @@ public class SplitLogManager extends ZooKeeperListener {
     // a single thread touches batch.installed.
     oldtask = tasks.putIfAbsent(path, new Task(batch));
     if (oldtask != null) {
+      // new task was not used.
+      batch.installed--;
       synchronized (oldtask) {
-        // new task was not used.
-        batch.installed--;
         if (oldtask.isOrphan()) {
           if (oldtask.deleted) {
             // The task is already done. Do not install the batch for this
@@ -608,12 +606,12 @@ public class SplitLogManager extends ZooKeeperListener {
             // this task to complete.
             return (null);
           }
-          LOG.info("Previously orphan task " + path +
-              " is now being waited upon");
           oldtask.setBatch(batch);
-          return (null);
         }
       }
+      LOG.info("Previously orphan task " + path +
+          " is now being waited upon");
+      return (null);
     }
     return oldtask;
   }
-- 
1.7.0.4

